<!DOCTYPE html>
<html lang="en">
<head>
    <script src="./../dictionary.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Translation Quiz</title>
<style>
    /* === MODAL WINDOWS === */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1001;
        justify-content: center;
        align-items: center;
        padding: 20px;
        backdrop-filter: blur(2px);
    }
    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 600px;
        overflow: hidden;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #eaeaea;
        background: #f8f6fb;
    }
    .modal-header h3 {
        margin: 0;
        color: #5a5a5a;
        font-size: 16px;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        transition: color 0.2s;
    }
    .modal-close:hover {
        color: #555;
    }
    .friends-grid {
        display: grid;
        gap: 8px;
        padding: 16px 20px;
        max-height: 400px;
        overflow-y: auto;
    }
    .friend-card {
        padding: 12px;
        background: #f9f7fc;
        border: 1px solid #d9d4e7;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #5a5a5a;
        transition: all 0.2s ease;
    }
    .friend-card:hover {
        background: #f0eaf9;
        border-color: #d9d4e7;
        transform: translateY(-1px);
    }
    .info-message {
        text-align: center;
        color: #777;
        padding: 20px;
        font-style: italic;
        display: none; /* Hidden by default */
    }
    /* === CHAT MODAL WINDOW === */
    .chat-modal .modal-header {
        background: #fffaf7;
    }
    .chat-modal .modal-content {
        /* Increase modal window size */
        width: 95%; /* Or even 98% */
        max-width: 900px; /* Or larger, e.g., 1200px */
        /* Can slightly increase height if needed */
        /* max-height: 90vh; */ /* Example: 90% viewport height */
    }
    #loadingIframe {
        text-align: center;
        padding: 30px;
        color: #777;
        display: block; /* Shown by default */
    }
    .chat-iframe {
        width: 100%;
        /* min-height: 500px; */ /* Can increase or make relative */
        min-height: 70vh; /* E.g., 70% viewport height */
        border: none;
        border-top: 1px solid #eee;
        border-radius: 0 0 12px 12px;
        display: none; /* Hidden by default */
    }
    /* Styling the "✉️" button like .task-type */
    #sendTaskBtn {
        /* Remove old button styles */
        background: #e6f4f1; /* Background color like task-type */
        color: #5a9a8f; /* Text color like task-type */
        border: 1px solid #c2e3dd; /* Border like task-type */
        /* Apply styles like task-type */
        padding: 3px 8px; /* Same as task-type */
        border-radius: 12px; /* Same as task-type */
        font-size: 11px; /* Same as task-type */
        line-height: 1.2; /* Same or close value */
        white-space: nowrap; /* Prevent text wrapping */
        /* Add specific button properties */
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s; /* Smooth transitions */
        /* Remove min-width and width so size adjusts to content */
        min-width: auto;
        width: auto;
    }
    /* Hover styles for the button */
    #sendTaskBtn:hover:not(:disabled) {
        background-color: #c2e3dd; /* Darker background shade */
        color: #3c766f; /* Darker text color */
        border-color: #a8d8ce; /* Darker border */
    }
    /* Styles for disabled button (if needed) */
    #sendTaskBtn:disabled {
        background-color: #c0c0c0; /* Gray background */
        border-color: #a0a0a0;
        color: #777;
        cursor: not-allowed;
        opacity: 0.7; /* Slightly transparent */
    }
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.5;
        color: #5a5a5a; /* Soft gray text */
        padding: 10px;
        background-color: #fdf6f0; /* Pastel peach background */
        font-size: 14px;
    }
    .container {
        max-width: 100%;
        margin: 0 auto;
    }
    .header {
        background-color: #fffaf7; /* Light peach */
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 10px;
        text-align: center;
        border: 1px solid #f5e1da; /* Pastel coral */
    }
    .header h1 {
        color: #7c6b96; /* Pastel purple */
        font-size: 18px;
        margin-bottom: 5px;
    }
    .header p {
        font-size: 12px;
        color: #a0a0a0;
    }
    .progress {
        background-color: #e6f4f1; /* Pastel mint */
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 10px;
        text-align: center;
        font-weight: bold;
        color: #5a9a8f; /* Muted blue-green */
        font-size: 13px;
        border: 1px solid #c2e3dd;
    }
    /* Collapsible Dictionary */
    .collapsible-container {
        border: 1px solid #d9d4e7; /* Pastel lavender */
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .collapsible-header {
        background-color: #f8f6fb; /* Very light lavender */
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
        color: #7c6b96;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        font-size: 13px;
        border-bottom: 1px solid #eae5f3;
    }
    .collapsible-header::after {
        content: "+";
        font-size: 18px;
        color: #9b9b9b;
    }
    .collapsible-header.active::after {
        content: "−";
    }
    .collapsible-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: #fffdfb;
    }
    .collapsible-content.show {
        max-height: 400px;
        padding: 10px;
    }
    .dictionary-content {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
    }
    .dict-item {
        padding: 6px;
        background-color: #f9f7fc; /* Very light lavender */
        border-radius: 6px;
        border: 1px solid #ece8f3;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 55px;
    }
    .dict-item:hover {
        background-color: #f0eaf9; /* Light violet hover */
        border-color: #d9d4e7;
    }
    .dict-char {
        font-size: 16px;
        font-weight: bold;
        color: #7c6b96;
        margin-bottom: 4px;
    }
    .dict-pinyin {
        font-size: 11px;
        color: #999999;
        margin-bottom: 2px;
    }
    .dict-meaning {
        font-size: 10px;
        color: #777777;
    }
    .task-container {
        background-color: #fffdfb;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 12px;
    }
    .source-text {
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        margin-bottom: 12px;
        background-color: #f8f6fb;
        border-radius: 6px;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #eae5f3;
    }
    .task-type {
        display: inline-block;
        background-color: #e6f4f1;
        color: #5a9a8f;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-bottom: 8px;
        border: 1px solid #c2e3dd;
        /* Add these properties for better button matching */
        line-height: 1.2; /* Or suitable value */
        white-space: nowrap; /* Prevent text wrapping */
    }
    .words-container, .answer-container {
        border: 1px dashed #d9d4e7;
        border-radius: 6px;
        padding: 10px;
        min-height: 50px;
        margin-bottom: 12px;
        background-color: #f9f7fc;
        font-size: 13px;
    }
    .words-container {
        background-color: #f9f7fc;
    }
    .answer-container {
        background-color: #f0faf8; /* Mint-cream */
        border-color: #a8d8ce;
    }
    .word-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    .word {
        padding: 6px 10px;
        background-color: #fff;
        border: 1px solid #e0d8e9;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .word:hover {
        background-color: #f0eaf9;
        transform: translateY(-1px);
        border-color: #d9d4e7;
    }
    .word.selected {
        background-color: #ffb6c1; /* Light pink (pastel) */
        color: #ffffff;
        border-color: #ff99ab; /* Slightly more saturated pink */
        box-shadow: 0 2px 4px rgba(255, 182, 193, 0.4); /* Light shadow for better visibility */
    }
    #resultMessage {
        min-height: 20px;
        text-align: center;
        font-weight: bold;
        margin: 10px 0;
        padding: 8px;
        border-radius: 6px;
        font-size: 13px;
    }
    .success {
        background-color: #e8f4f1;
        color: #3c766f;
        border: 1px solid #c2e3dd;
    }
    .info {
        background-color: #f0f4fb;
        color: #4a6fa5;
        border: 1px solid #d0ddf0;
    }
    .congratulations {
        text-align: center;
        padding: 20px 12px;
        background-color: #fffdfb;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f5e1da;
    }
    .congratulations h2 {
        color: #c28e8e; /* Pastel pinkish-brown */
        margin-bottom: 12px;
        font-size: 18px;
    }
    .congratulations p {
        font-size: 14px;
        margin-bottom: 15px;
        color: #777;
    }
    .btn {
        display: block;
        width: 100%;
        padding: 12px;
        background-color: #a8c8d8; /* Pastel bluish-cyan */
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 15px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 8px;
        border: 1px solid #8fb8cc;
    }
    .btn:hover {
        background-color: #8fb8cc;
    }
    .btn-success {
        background-color: #c2e3dd; /* Pastel mint */
        border: 1px solid #a8d8ce;
    }
    .btn-success:hover {
        background-color: #a8d8ce;
    }
    /* Glow Animation */
    @keyframes glow {
        0% { box-shadow: 0 0 5px #c2e3dd, 0 0 10px #c2e3dd; }
        50% { box-shadow: 0 0 15px #c2e3dd, 0 0 25px #c2e3dd; }
        100% { box-shadow: 0 0 5px #c2e3dd, 0 0 10px #c2e3dd; }
    }
    .dict-item.glow {
        animation: glow 0.3s ease-in-out;
    }
    /* Hint styles */
    .hint-container {
        margin-top: 10px;
        padding: 8px;
        background-color: #fff9e6; /* Pastel yellow-cream */
        border: 1px solid #f5e6c8;
        border-radius: 6px;
        font-size: 12px;
        color: #9a8c5a;
        display: none;
    }
    .hint-container.show {
        display: block;
    }
    #hintBtn {
        background-color: #f5e6c8;
        color: #5a5a5a;
        border: 1px solid #f5e6c8;
    }
    #hintBtn:hover:not(:disabled) {
        background-color: #e6d4b0;
        border-color: #d9c69e;
    }
    #hintBtn:disabled {
        background-color: #c0c0c0;
        border-color: #a0a0a0;
        cursor: not-allowed;
    }
    /* Adaptation for very small screens */
    @media (max-width: 360px) {
        .dictionary-content {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
        }
        .dict-item {
            padding: 5px;
            min-height: 50px;
        }
        .dict-char {
            font-size: 15px;
        }
        .dict-pinyin {
            font-size: 10px;
        }
        .dict-meaning {
            font-size: 9px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Translation Quiz</h1>
            <p>Match the text with the translation</p>
        </div>
        <div class="progress">
            Remaining: <span id="tasksLeft">0</span>
        </div>
        <!-- Collapsible Dictionary -->
        <div class="collapsible-container">
            <div class="collapsible-header" id="collapsibleHeader"> <!-- ID for JS -->
                <span>📚 Dictionary (click to expand)</span>
            </div>
            <div class="collapsible-content" id="collapsibleContent"> <!-- ID for JS -->
                <div class="dictionary-content" id="dictionaryContent"></div>
            </div>
        </div>
        <div id="mainContent">
            <div class="task-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div class="task-type" id="taskType">Translation from Chinese</div>
                    <button id="sendTaskBtn" title="Send task">Send to PM ✉️</button>
                </div>
                <div class="source-text" id="sourceText">Loading...</div>
                <div class="words-container">
                    <div class="word-list" id="wordsList"></div>
                </div>
                <div class="answer-container">
                    <div class="word-list" id="answerList"></div>
                </div>
                <!-- Hint container -->
                <div class="hint-container" id="hintContainer">
                    Correct answer: <span id="hintText"></span>
                </div>
                <!-- Hint button -->
                <button id="hintBtn" class="btn">Peek at the correct answer (-7 points)</button>
                <div id="resultMessage"></div>
            </div>
        </div>
        <div id="congratulations" class="congratulations" style="display: none;">
            <h2>🎉 Congratulations!</h2>
            <p>You have completed all tasks!</p>
            <button class="btn btn-success" id="returnBtn">Return to Main</button>
        </div>
    </div>
    <!-- Connect data -->
    <script src="segmentation.js"></script>
    <script src="extra.js"></script>
    <script>
        // Firebase initialization function
// ==================== FIREBASE INIT ====================
// Define global variables for Firebase
let auth = null;
let db = null;
let currentUser = null;
let docRef = null;
let getDocRef = null;
let updateDocRef = null;
let collectionRef = null;
let queryRef = null;
let whereRef = null;
let getDocsRef = null; // <-- New global variable for getDocs
function getRandomDecoyCount(min = 1, max = 5) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
// Firebase initialization function
async function initFirebase() {
    try {
        // Dynamically import Firebase modules (remove extra spaces from URL)
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js');
        const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js');
        // Import ALL necessary Firestore functions
        const { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js');
        const firebaseConfig = {
            apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
            authDomain: "antient-9bff0.firebaseapp.com",
            projectId: "antient-9bff0",
            storageBucket: "antient-9bff0.firebasestorage.app",
            messagingSenderId: "311792589414",
            appId: "1:311792589414:web:5fff3154735007c2006ba7",
            measurementId: "G-W4ZQXWRTKK"
        };
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        // Assign Firebase functions to global variables
        docRef = doc;
        getDocRef = getDoc;
        updateDocRef = updateDoc;
        collectionRef = collection;
        queryRef = query;
        whereRef = where;
        getDocsRef = getDocs; // <-- Very important: assign getDocs
        // Use async/await to get the full user profile
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('🔐 User logged in (auth state):', user.uid);
                try {
                    // Request the user document from Firestore
                    const userDocRef = docRef(db, 'users', user.uid);
                    const userDocSnap = await getDocRef(userDocRef); // Use getDocRef for a single document
                    if (userDocSnap.exists()) {
                        // Now currentUser has .friends and other data from Firestore
                        currentUser = { uid: user.uid, ...userDocSnap.data() };
                        console.log('✅ User profile loaded from Firestore:', currentUser);
                    } else {
                        console.error('❌ Profile not found in Firestore for UID:', user.uid);
                        // location.href = '../index.html'; // Optional
                    }
                } catch (profileError) {
                    console.error('❌ Error loading profile from Firestore for UID:', user.uid, profileError);
                    // alert('Failed to load user data.');
                }
            } else {
                console.warn('🔒 User not authorized');
                currentUser = null;
            }
        });
        console.log("Firebase initialized");
    } catch (e) {
        console.error("❌ Firebase initialization error:", e);
        // Even if Firebase is not initialized, the application can continue (without sending messages)
    }
}
        // ==================== POINT SYSTEM ====================
        async function updateUserPoints(pointsChange) {
            // If Firebase is not initialized or the user is not authorized
            if (!auth || !db || !currentUser || !docRef || !getDocRef || !updateDocRef) {
                const message = pointsChange !== 0 ?
                    `Points change: ${pointsChange} (not saved - Firebase not ready)` :
                    '';
                if(message) console.log(message);
                return;
            }
            try {
                const userRef = docRef(db, 'users', currentUser.uid);
                // Get the user's current points
                const userDoc = await getDocRef(userRef);
                let currentPoints = 0;
                if (userDoc.exists()) {
                    currentPoints = userDoc.data().points || 0;
                }
                // Update points considering current points
                const newPoints = currentPoints + pointsChange;
                await updateDocRef(userRef, {
                    points: newPoints
                });
                currentUser.points = newPoints;
                console.log(`[Points] Change: ${pointsChange}. Now: ${newPoints}`);
                // Optional: update points display on the page, if any
            } catch (e) {
                console.error("❌ Failed to save points to Firestore:", e);
            }
        }
        // ==================== INTERFACE SOUNDS ====================
        const uiSounds = {
            click: null,
            hover: null,
            success: null,
            expand: null,
            collapse: null,
            hint: null // New sound for hint
        };
        // Function to preload one sound
        function preloadSound(path) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                audio.src = path;
                audio.preload = 'auto';
                audio.addEventListener('canplaythrough', () => resolve(audio));
                audio.addEventListener('error', reject);
            });
        }
        // Function to preload all interface sounds
        async function preloadUISounds() {
            try {
                // Relative path from translateall.html to the Wav folder
                const basePath = '../Wav/';
                // Preload sounds
                uiSounds.click = await preloadSound(basePath + 'Click_Standard_00.wav');
                uiSounds.hover = await preloadSound(basePath + 'Click_Soft_00.wav');
                uiSounds.success = await preloadSound(basePath + 'Click_Electronic/Click_Electronic_05.wav');
                uiSounds.expand = await preloadSound(basePath + 'Slide_Electronic_00.wav');
                uiSounds.collapse = await preloadSound(basePath + 'Slide_Electronic_01.wav');
                // Sound for hint
                uiSounds.hint = await preloadSound(basePath + 'Click_Mechanical_00.wav');
                console.log('All interface sounds loaded successfully');
            } catch (error) {
                console.warn('Failed to load some interface sounds:', error);
            }
        }
        // Function to play sound
        function playSound(sound) {
            if (sound) {
                // Create a clone to allow multiple plays
                const soundClone = sound.cloneNode();
                soundClone.volume = 0.3; // Reduce volume
                soundClone.play().catch(e => {
                    console.warn('Failed to play sound:', e);
                });
            }
        }
        // ==================== EXISTING CODE ====================
        // Audio file cache
        const audioCache = new Map();
        let hintUsedForCurrentTask = false; // Hint usage flag
        // Function to preload audio
        function preloadAudioForCharacters(characters) {
            characters.forEach(hanzi => {
                // Check if the character is in the charData dictionary
                if (!charData || !charData.hasOwnProperty(hanzi)) return;
                const charInfo = charData[hanzi];
                if (!charInfo || !charInfo.pinyin) return;
                const pinyin = charInfo.pinyin;
                let cleanPinyin = pinyin
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/ü/g, 'u')
                    .replace(/v/g, 'u');
                let tone = '1';
                if (pinyin.includes('ā') || pinyin.includes('ō') || pinyin.includes('ē') || pinyin.includes('ī') || pinyin.includes('ū') || pinyin.includes('ǖ')) tone = '1';
                else if (pinyin.includes('á') || pinyin.includes('ó') || pinyin.includes('é') || pinyin.includes('í') || pinyin.includes('ú') || pinyin.includes('ǘ')) tone = '2';
                else if (pinyin.includes('ǎ') || pinyin.includes('ǒ') || pinyin.includes('ě') || pinyin.includes('ǐ') || pinyin.includes('ǔ') || pinyin.includes('ǚ')) tone = '3';
                else if (pinyin.includes('à') || pinyin.includes('ò') || pinyin.includes('è') || pinyin.includes('ì') || pinyin.includes('ù') || pinyin.includes('ǜ')) tone = '4';
                const pinyinKey = cleanPinyin + tone;
                // Fix URL - remove extra spaces
                const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
                if (!audioCache.has(hanzi)) {
                    const audio = new Audio();
                    audio.src = url;
                    audio.preload = 'auto';
                    audioCache.set(hanzi, audio);
                    audio.addEventListener('error', (e) => {
                        console.warn(`Failed to preload audio for ${hanzi}`);
                    });
                }
            });
        }
        // Function to play character sounds with visual feedback
        function playHanziSound(hanzi, element) {
            // Check if the character is in the charData dictionary
            if (!charData || !charData.hasOwnProperty(hanzi)) return;
            // Visual feedback - pearl highlight
            if (element) {
                const originalBg = element.style.backgroundColor || (element.classList.contains('selected') ? '#2ecc71' : '#fff');
                element.style.backgroundColor = '#e0f7fa';
                setTimeout(() => {
                    element.style.backgroundColor = originalBg;
                }, 300);
            }
            if (audioCache.has(hanzi)) {
                const audio = audioCache.get(hanzi);
                const audioClone = audio.cloneNode();
                audioClone.play().catch(e => {
                    console.warn(`Failed to play cached audio for ${hanzi}`);
                });
            } else {
                const charInfo = charData[hanzi];
                if (!charInfo || !charInfo.pinyin) return;
                const pinyin = charInfo.pinyin;
                let cleanPinyin = pinyin
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/ü/g, 'u')
                    .replace(/v/g, 'u');
                let tone = '1';
                if (pinyin.includes('ā') || pinyin.includes('ō') || pinyin.includes('ē') || pinyin.includes('ī') || pinyin.includes('ū') || pinyin.includes('ǖ')) tone = '1';
                else if (pinyin.includes('á') || pinyin.includes('ó') || pinyin.includes('é') || pinyin.includes('í') || pinyin.includes('ú') || pinyin.includes('ǘ')) tone = '2';
                else if (pinyin.includes('ǎ') || pinyin.includes('ǒ') || pinyin.includes('ě') || pinyin.includes('ǐ') || pinyin.includes('ǔ') || pinyin.includes('ǚ')) tone = '3';
                else if (pinyin.includes('à') || pinyin.includes('ò') || pinyin.includes('è') || pinyin.includes('ì') || pinyin.includes('ù') || pinyin.includes('ǜ')) tone = '4';
                const pinyinKey = cleanPinyin + tone;
                // Fix URL - remove extra spaces
                const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
                const audio = new Audio(url);
                audio.play().catch(e => {
                    console.warn(`Failed to play sound for ${hanzi}: ${url}`);
                });
            }
        }
        // Function to play dictionary character sound with glow effect
        function playDictionaryHanziSound(hanzi, element) {
            // Add glow class
            element.classList.add('glow');
            // Remove class after 300ms
            setTimeout(() => {
                element.classList.remove('glow');
            }, 300);
            // Play sound
            playHanziSound(hanzi, element);
        }
        // Function to display dictionary
        function renderDictionary() {
            const dictionaryContent = document.getElementById('dictionaryContent');
            dictionaryContent.innerHTML = '';
            // Extract text from all necessary places
            const sourceText = document.getElementById('sourceText').textContent;
            const wordsList = document.getElementById('wordsList').textContent;
            const answerList = document.getElementById('answerList').textContent;
            const allText = sourceText + wordsList + answerList;
            const chars = [...allText]; // split into characters
            // Get unique characters that exist in charData
            const uniqueChars = [...new Set(chars)]
                .filter(char => charData && charData.hasOwnProperty(char));
            uniqueChars.forEach(char => {
                const charInfo = charData[char];
                const dictItem = document.createElement('div');
                dictItem.className = 'dict-item';
                dictItem.dataset.hanzi = char;
                dictItem.innerHTML = `
                    <div class="dict-char">${char}</div>
                    <div class="dict-pinyin">${charInfo.pinyin}</div>
                    <div class="dict-meaning">${charInfo.meaning}</div>
                `;
                // Add sound on click on dictionary item
                dictItem.addEventListener('click', function() {
                    playSound(uiSounds.click); // Play interface sound
                    playDictionaryHanziSound(char, this);
                });
                dictionaryContent.appendChild(dictItem);
            });
        }
        document.addEventListener('DOMContentLoaded', async function() { // async
            // ==================== INITIALIZATION ====================
            await initFirebase(); // Wait for Firebase initialization
            await preloadUISounds(); // Wait for sound loading
            // ==================== FUNCTIONS ====================
            // Function to form task string with correct quotes
            function getTaskShareString(task, currentAnswerWords) {
                const tokens = task.words.map(w => `"${w}"`).join(', ');
                if (task.type === 'toTranslation') {
                    return `’‘’‘ [original]->[translation]: {"${task.source}"}->{"${task.correctAnswer}"}; [tokens]: {${tokens}} ’‘’‘`;
                } else {
                    return `’‘’‘ [translation]->[original]: {"${task.source}"}->{"${task.correctAnswer}"}; [tokens]: {${tokens}} ’‘’‘`;
                }
            }
            // ==================== INTERFACE EVENTS ====================
            // Collapsible dictionary
            const collapsibleHeader = document.getElementById('collapsibleHeader');
            const collapsibleContent = document.getElementById('collapsibleContent');
            const sendTaskBtn = document.getElementById('sendTaskBtn');
            // === DOM ELEMENTS FOR MODAL WINDOWS ===
            const modalSelectRecipient = document.getElementById('modalSelectRecipient');
            const closeRecipientModalBtn = document.getElementById('closeRecipientModalBtn');
            const recipientList = document.getElementById('recipientList');
            const noFriendsMessage = document.getElementById('noFriendsMessage');
            const modalShareTask = document.getElementById('modalShareTaskChat'); // Use unique ID
            const closeModalBtn = document.getElementById('closeModalBtnChat'); // Use unique ID
            const shareTaskFrame = document.getElementById('shareTaskFrame');
            const loadingIframe = document.getElementById('loadingIframe');
            // === ✉️ BUTTON HANDLER ===
            sendTaskBtn.addEventListener('click', async function() {
                playSound(uiSounds.click);
                if (!currentUser || !currentUser.uid) {
                    alert('⛔ Please log in first.');
                    return;
                }
                // Check if the friends array is loaded
                if (!Array.isArray(currentUser.friends)) {
                    alert('Friend data is still loading or missing... Please try again later.');
                    console.warn("currentUser.friends is not an array or missing:", currentUser.friends);
                    return;
                }
                modalSelectRecipient.style.display = 'flex';
                loadFriendsForSelection();
            });
            // === LOAD FRIENDS ===
// === LOAD FRIENDS ===
async function loadFriendsForSelection() {
    const recipientList = document.getElementById('recipientList');
    const noFriendsMessage = document.getElementById('noFriendsMessage');
    recipientList.innerHTML = '<div style="text-align:center;padding:10px;">Loading friends...</div>';
    noFriendsMessage.style.display = 'none';
    // Repeated and stricter check inside the function
    if (!currentUser || !Array.isArray(currentUser.friends) || currentUser.friends.length === 0) {
        console.warn("No friends to load or currentUser.friends is not an array:", currentUser?.friends);
        recipientList.innerHTML = '';
        noFriendsMessage.style.display = 'block';
        return;
    }
    try {
        // Create a reference to the users collection
        const friendsRef = collectionRef(db, 'users');
        // Create a query with filter by friend IDs
        // Limit to 10, as the 'in' query in Firestore is limited to 10 elements
        const friendsToQuery = currentUser.friends.slice(0, 10);
        const q = queryRef(friendsRef, whereRef('__name__', 'in', friendsToQuery));
        // Use getDocsRef to execute the query returning multiple documents
        const querySnap = await getDocsRef(q); // <-- Fixed: was getDocRef(q)
        const friends = [];
        querySnap.forEach(doc => {
            friends.push({ id: doc.id, ...doc.data() });
        });
        recipientList.innerHTML = '';
        if (friends.length === 0) {
            recipientList.innerHTML = '<div style="text-align:center;color:#777">Friends not found</div>';
            return;
        }
        // Only list names and points
        friends.forEach(friend => {
            const card = document.createElement('div');
            card.className = 'friend-card';
            // Only text
            card.textContent = `${friend.displayName} (${friend.points || 0} points)`;
            // Styles are already defined in CSS, add click handler
            card.addEventListener('click', () => selectRecipient(friend));
            recipientList.appendChild(card);
        });
    } catch (error) {
        console.error("Error loading friends:", error);
        recipientList.innerHTML = '<div style="text-align:center;color:red">Loading error</div>';
    }
}
            // === SELECT RECIPIENT ===
            function selectRecipient(friend) {
                modalSelectRecipient.style.display = 'none';
                const task = tasks[currentTaskIndex];
                const shareString = getTaskShareString(task, currentAnswer);
                const encodedShareString = encodeURIComponent(shareString);
                const chatUrl = `../chat.html#chat/${friend.id}/${encodedShareString}`;
                // Show chat modal window
                modalShareTask.style.display = 'flex';
                shareTaskFrame.src = '';
                loadingIframe.style.display = 'block';
                shareTaskFrame.style.display = 'none';
                setTimeout(() => {
                    shareTaskFrame.src = chatUrl;
                }, 10);
                shareTaskFrame.onload = () => {
                    loadingIframe.style.display = 'none';
                    shareTaskFrame.style.display = 'block';
                };
            }
            // === CLOSE MODALS ===
            closeRecipientModalBtn?.addEventListener('click', () => {
                modalSelectRecipient.style.display = 'none';
            });
            closeModalBtn?.addEventListener('click', () => {
                modalShareTask.style.display = 'none';
                shareTaskFrame.src = '';
            });
            // Close with Esc
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (modalSelectRecipient.style.display !== 'none') {
                        modalSelectRecipient.style.display = 'none';
                    }
                    if (modalShareTask.style.display !== 'none') {
                        modalShareTask.style.display = 'none';
                        shareTaskFrame.src = '';
                    }
                }
            });
            // Close by clicking outside
            modalSelectRecipient?.addEventListener('click', (e) => {
                if (e.target === modalSelectRecipient) modalSelectRecipient.style.display = 'none';
            });
            modalShareTask?.addEventListener('click', (e) => {
                if (e.target === modalShareTask) modalShareTask.style.display = 'none';
            });
            collapsibleHeader.addEventListener('click', function() {
                this.classList.toggle('active');
                collapsibleContent.classList.toggle('show');
                // Play sound depending on state
                if (collapsibleContent.classList.contains('show')) {
                    playSound(uiSounds.expand);
                } else {
                    playSound(uiSounds.collapse);
                }
            });
            // "Return to Main" button
            const returnBtn = document.getElementById('returnBtn');
            returnBtn.addEventListener('click', function() {
                playSound(uiSounds.click);
                window.location.href = '../index.html';
            });
            // Hover effects for buttons (except hintBtn)
            document.querySelectorAll('.btn:not(#hintBtn), .word, .dict-item').forEach(el => {
                el.addEventListener('mouseenter', () => playSound(uiSounds.hover));
            });
            // ==================== HINT LOGIC ====================
            const hintBtn = document.getElementById('hintBtn');
            const hintContainer = document.getElementById('hintContainer');
            const hintText = document.getElementById('hintText');
            hintBtn.addEventListener('click', async function() {
                if (hintUsedForCurrentTask) return; // Protection against reuse
                playSound(uiSounds.hint); // Play hint sound
                hintUsedForCurrentTask = true;
                this.disabled = true;
                // Deduct points
                await updateUserPoints(-7);
                // Show hint
                const currentTask = tasks[currentTaskIndex];
                if (currentTask.type === 'toTranslation') {
                    hintText.textContent = currentTask.correctAnswer;
                } else {
                    // For English to Chinese translation, show characters separately
                    hintText.textContent = currentTask.correctAnswer.split('').join(' ');
                }
                hintContainer.classList.add('show');
            });
            // ==================== MAIN LOGIC ====================
            // Data preparation
            // Check SentenceData is now inside DOMContentLoaded, where it is guaranteed to be loaded
            // Check main data
            if (typeof SentenceData === 'undefined' || !SentenceData.sentences || !Array.isArray(SentenceData.sentences)) {
                console.error("SentenceData not loaded or has incorrect format!");
                document.getElementById('sourceText').textContent = "Error: lesson data not loaded.";
                return;
            }
            // Check additional data (optional, but if present - must be valid)
            let extraSentences = [];
            if (typeof extra !== 'undefined' && extra.sentences && Array.isArray(extra.sentences)) {
                console.log(`✅ Loaded ${extra.sentences.length} additional sentences from extra.js`);
                extraSentences = extra.sentences;
            } else {
                console.warn("⚠️ File extra.js not loaded or has incorrect format. Continuing without additional tasks.");
            }
            // Combine sentences from main and additional sources
            const allSentences = [...SentenceData.sentences, ...extraSentences];
            const allOriginals = allSentences.map(s => s.original);
            const allTranslations = allSentences.map(s => s.translation);
            function cleanEnglish(text) {
                return text.replace(/[^\p{L}\p{N}\s]/gu, '').toLowerCase().trim();
            }
            const allEnglishWords = [];
            allTranslations.forEach(trans => {
                const cleaned = cleanEnglish(trans);
                allEnglishWords.push(...cleaned.split(' ').filter(word => word));
            });
            const allChineseChars = [];
            allOriginals.forEach(orig => {
                allChineseChars.push(...orig.split(''));
            });
            function shuffleArray(array) {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }
            let tasks = [];
            allSentences.forEach(sentence => {
                const actualEnglishWords = cleanEnglish(sentence.translation).split(' ').filter(w => w);
                const actualChineseChars = sentence.original.split('');
                // --- For Chinese to English translation ---
                // Filter the common word pool: only those NOT in the actual answer
                const availableEnglishDecoys = allEnglishWords.filter(word => !actualEnglishWords.includes(word));
                // Remove duplicates from the decoy pool
                const uniqueEnglishDecoys = [...new Set(availableEnglishDecoys)];
                // Shuffle
                const shuffledEnglishDecoys = shuffleArray(uniqueEnglishDecoys);
                // Take a random number from 1 to 5, but not more than available
                const russianDecoyCount = Math.min(getRandomDecoyCount(), shuffledEnglishDecoys.length);
                const russianDecoys = shuffledEnglishDecoys.slice(0, russianDecoyCount);
                tasks.push({
                    type: 'toTranslation',
                    source: sentence.original,
                    correctAnswer: cleanEnglish(sentence.translation),
                    words: shuffleArray([...actualEnglishWords, ...russianDecoys]),
                    direction: 'from Chinese to English'
                });
                // --- For English to Chinese translation ---
                const availableChineseDecoys = allChineseChars.filter(char => !actualChineseChars.includes(char));
                const uniqueChineseDecoys = [...new Set(availableChineseDecoys)];
                const shuffledChineseDecoys = shuffleArray(uniqueChineseDecoys);
                const chineseDecoyCount = Math.min(getRandomDecoyCount(), shuffledChineseDecoys.length);
                const chineseDecoys = shuffledChineseDecoys.slice(0, chineseDecoyCount);
                tasks.push({
                    type: 'toOriginal',
                    source: sentence.translation,
                    correctAnswer: sentence.original,
                    words: shuffleArray([...actualChineseChars, ...chineseDecoys]),
                    direction: 'from English to Chinese'
                });
            });
            tasks = shuffleArray(tasks);
            let currentTaskIndex = 0;
            let currentAnswer = [];
            const sourceText = document.getElementById('sourceText');
            const wordsList = document.getElementById('wordsList');
            const answerList = document.getElementById('answerList');
            const resultMessage = document.getElementById('resultMessage');
            const tasksLeft = document.getElementById('tasksLeft');
            const taskType = document.getElementById('taskType');
            const mainContent = document.getElementById('mainContent');
            const congratulations = document.getElementById('congratulations');
            const returnBtnCongrats = document.getElementById('returnBtn'); // Already exists, reuse
            function renderTask() {
                if (currentTaskIndex >= tasks.length) {
                    showCompletionScreen();
                    return;
                }
                // Reset hint state for new task
                hintUsedForCurrentTask = false;
                hintBtn.disabled = false;
                hintContainer.classList.remove('show');
                const task = tasks[currentTaskIndex];
                taskType.textContent = `Translation ${task.direction}`;
                sourceText.textContent = task.source;
                tasksLeft.textContent = tasks.length - currentTaskIndex;
                currentAnswer = [];
                answerList.innerHTML = '';
                wordsList.innerHTML = '';
                if (task.type === 'toOriginal') {
                    // Preload audio for Chinese characters
                    const chineseCharacters = task.words.filter(word => charData && charData.hasOwnProperty(word));
                    preloadAudioForCharacters(chineseCharacters);
                }
                task.words.forEach(word => {
                    const el = document.createElement('div');
                    el.className = 'word';
                    el.textContent = word;
                    el.dataset.word = word;
                    wordsList.appendChild(el);
                });
                document.querySelectorAll('#wordsList .word').forEach(el => {
                    el.addEventListener('click', async function() { // async
                        playSound(uiSounds.click); // Play interface sound
                        const word = this.dataset.word;
                        // Play sound with visual feedback
                        playHanziSound(word, this);
                        this.remove();
                        const answerEl = document.createElement('div');
                        answerEl.className = 'word selected';
                        answerEl.textContent = word;
                        answerEl.dataset.word = word;
                        answerList.appendChild(answerEl);
                        currentAnswer.push(word);
                        await checkAnswer(); // Check immediately after adding
                    });
                });
                // Display dictionary after rendering task
                setTimeout(renderDictionary, 100);
                resultMessage.className = 'info';
                resultMessage.textContent = 'Assemble the translation. Click on a character to hear it.';
            }
            // ========== CHANGED CHECK LOGIC ==========
            async function checkAnswer() {
                const task = tasks[currentTaskIndex];
                const currentText = currentAnswer.join(' ').trim();
                if (task.type === 'toTranslation') {
                    if (currentText === task.correctAnswer) {
                        playSound(uiSounds.success); // Play success sound
                        await updateUserPoints(5); // Award 5 points
                        showSuccess();
                    }
                } else {
                    const currentTextOriginal = currentAnswer.join(''); // For Chinese, join without spaces
                    if (currentTextOriginal === task.correctAnswer) {
                        playSound(uiSounds.success); // Play success sound
                        await updateUserPoints(5); // Award 5 points
                        showSuccess();
                    }
                    // Similarly for English to Chinese translation
                    // else if (currentAnswer.length >= task.correctAnswer.length) {
                    //    // Tolerant - No reaction
                    // }
                }
            }
            function showSuccess() {
                resultMessage.className = 'success';
                resultMessage.textContent = '✅ Correct! +5 points. Next task...';
                setTimeout(() => {
                    currentTaskIndex++;
                    renderTask();
                }, 1200);
            }
            answerList.addEventListener('click', async function(e) { // async
                if (e.target.classList.contains('word')) {
                    playSound(uiSounds.click); // Play interface sound
                    const word = e.target.dataset.word;
                    // Play sound with visual feedback
                    playHanziSound(word, e.target);
                    e.target.remove();
                    const wordEl = document.createElement('div');
                    wordEl.className = 'word';
                    wordEl.textContent = word;
                    wordEl.dataset.word = word;
                    wordsList.appendChild(wordEl);
                    const index = currentAnswer.indexOf(word);
                    if (index !== -1) currentAnswer.splice(index, 1);
                    wordEl.addEventListener('click', async function() { // async
                        playSound(uiSounds.click); // Play interface sound
                        const w = this.dataset.word;
                        // Play sound with visual feedback
                        playHanziSound(w, this);
                        this.remove();
                        const aEl = document.createElement('div');
                        aEl.className = 'word selected';
                        aEl.textContent = w;
                        aEl.dataset.word = w;
                        answerList.appendChild(aEl);
                        currentAnswer.push(w);
                        await checkAnswer(); // Check after adding
                    });
                }
            });
            function showCompletionScreen() {
                mainContent.style.display = 'none';
                congratulations.style.display = 'block';
            }
            // Initialize the first task
            renderTask();
        });
    </script>
    <script src="../uploader.js"></script>
    <!-- Modal window for selecting recipient -->
    <div id="modalSelectRecipient" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📬 Select Recipient</h3>
                <button id="closeRecipientModalBtn" class="modal-close">×</button>
            </div>
            <div id="recipientList" class="friends-grid">
                <!-- Friend list will be loaded here -->
            </div>
            <div id="noFriendsMessage" class="info-message">
                You don't have any friends yet. Add them in the "Community" section.
            </div>
        </div>
    </div>
    <!-- Chat modal window (fixed ID) -->
    <div id="modalShareTaskChat" class="modal-overlay"> <!-- Unique ID -->
        <div class="modal-content chat-modal">
            <div class="modal-header">
                <h3>💬 Sending Task</h3>
                <button id="closeModalBtnChat" class="modal-close">×</button> <!-- Unique ID -->
            </div>
            <div id="loadingIframe">Loading chat...</div>
            <iframe id="shareTaskFrame" src="" class="chat-iframe" frameborder="0"></iframe>
        </div>
    </div>
</body>
</html>
