<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Character Quiz</title>
    <script src="../dictionary.js"></script>
    <link rel="stylesheet" type="text/css" href="../vocab.css">
</head>
<body>
    <div class="container">
        <h1>Match the Characters</h1>
        
        <div class="controls">
            <div id="status" class="status">Match the characters</div>
        </div>
        
        <div class="matching-container">
            <div class="column" id="leftColumn"></div>
            <div class="column" id="rightColumn"></div>
        </div>
        
        <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        
        <button id="nextBtn" class="btn">Next Task</button>
        
        <div class="feedback correct-feedback" id="correctFeedback">✓ Correct! +1 point</div>
        <div class="feedback incorrect-feedback" id="incorrectFeedback">✗ Incorrect -1 point</div>
    </div>

    <script>
        // === LESSON SETUP ===
        const LESSON =  parseInt((window.location.pathname.match(/\/lesson(\d+)(?:\/|$)/) || [])[1] || '1');
        
        // === UI SOUND SYSTEM ===
        const uiSounds = {
            click: null,
            hover: null,
            success: null,
            error: null,
            next: null,
            complete: null
        };

        // Function to preload a single sound
        function preloadSound(path) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                audio.src = path;
                audio.preload = 'auto';
                audio.addEventListener('canplaythrough', () => resolve(audio));
                audio.addEventListener('error', reject);
            });
        }

        // Function to preload all UI sounds
        async function preloadUISounds() {
            try {
                // Relative path to Wav folder
                const basePath = '../Wav/';

                // Preload sounds
                uiSounds.click = await preloadSound(basePath + 'Click_Standard_00.wav');
                uiSounds.hover = await preloadSound(basePath + 'Click_Soft_00.wav');
                uiSounds.success = await preloadSound(basePath + 'Click_Electronic/Click_Electronic_05.wav');
                uiSounds.error = await preloadSound(basePath + 'Click_Heavy_00.wav');
                uiSounds.next = await preloadSound(basePath + 'Slide_Sharp_00.wav');
                uiSounds.complete = await preloadSound(basePath + 'Click_Mechanical_01.wav');

                console.log('All UI sounds loaded successfully');
            } catch (error) {
                console.warn('Failed to load some UI sounds:', error);
            }
        }

        // Function to play sound
        function playSound(sound, volume = 0.3) {
            if (sound) {
                // Create a clone for multiple plays
                const soundClone = sound.cloneNode();
                soundClone.volume = volume;
                soundClone.play().catch(e => {
                    console.warn('Failed to play sound:', e);
                });
            }
        }

        // === FIREBASE INIT ===
        let db = null;
        let auth = null;
        let currentUser = null;
        let updateDocRef = null;
        let docRef = null;
        let getDocRef = null;

        async function initFirebase() {
            try {
                const [{ initializeApp }, { getAuth, onAuthStateChanged }, { getFirestore }, { updateDoc, doc, getDoc }] = await Promise.all([
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js    '),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js    '),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js    '),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js    ')
                ]);

                const firebaseConfig = {
                    apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
                    authDomain: "antient-9bff0.firebaseapp.com",
                    projectId: "antient-9bff0",
                    storageBucket: "antient-9bff0.firebasestorage.app",
                    messagingSenderId: "311792589414",
                    appId: "1:311792589414:web:5fff3154735007c2006ba7",
                    measurementId: "G-W4ZQXWRTKK"
                };

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                updateDocRef = updateDoc;
                docRef = doc;
                getDocRef = getDoc;

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    console.log('🔐 User:', user ? user.displayName : 'not logged in');
                });
            } catch (e) {
                console.error("❌ Firebase initialization error:", e);
            }
        }

        // === PRONUNCIATION AUDIO ===
function playHanziSound(hanzi) {
    const data = charData[hanzi];
    if (!data || !data.pinyin) return;

    let cleanPinyin = data.pinyin
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ü/g, 'u')
        .replace(/v/g, 'u');

    let tone = '1';
    if (data.pinyin.includes('ā')) tone = '1';
    else if (data.pinyin.includes('á')) tone = '2';
    else if (data.pinyin.includes('ǎ')) tone = '3';
    else if (data.pinyin.includes('à')) tone = '4';

    const pinyinKey = cleanPinyin + tone;
    const url = `https://data.dong-chinese.com/pinyin/b/  ${pinyinKey}.mp3`;

    // Create audio object
    const audio = new Audio(url);

    // 🚀 Use play() inside click handler
    // Ensures playback is user-initiated
    audio.play().catch(e => {
        console.warn(`🔇 No sound for ${hanzi}`, e.message);
    });
}
        // === POINT SYSTEM ===
        async function updateUserPoints(pointsChange) {
            if (!db || !currentUser || !updateDocRef || !docRef || !getDocRef) {
                console.warn("Firebase not initialized, points not saved");
                return;
            }

            try {
                const userRef = docRef(db, 'users', currentUser.uid);
                
                // Get current user points
                const userDoc = await getDocRef(userRef);
                let currentPoints = 0;
                
                if (userDoc.exists()) {
                    currentPoints = userDoc.data().points || 0;
                }
                
                // Update points
                const newPoints = currentPoints + pointsChange;
                
                await updateDocRef(userRef, {
                    points: newPoints
                });
                
                currentUser.points = newPoints;
                console.log(`[Points] Change: ${pointsChange}. Now: ${newPoints}`);
            } catch (e) {
                console.error("❌ Failed to save points to Firestore:", e);
            }
        }

        // === QUIZ LOGIC ===
        let selectedLeft = null;
        let selectedRight = null;
        let matchedPairs = 0;
        let totalPairs = 0;
        let leftItems = [];
        let rightItems = [];
        let allLessonChars = [];
        
        // Track progress per character
        let charProgress = {};
        let currentTaskType = ''; // 'pinyin' or 'meaning'
        let currentChars = [];

        // Initialization
        document.addEventListener('DOMContentLoaded', async function() {
            await initFirebase();
            await preloadUISounds(); // Wait for sounds to load
            
            // Get all lesson characters
            allLessonChars = Object.keys(charData).filter(char => 
                charData[char].lesson === LESSON
            );
            
            totalPairs = allLessonChars.length * 2; // Each character tested twice
            
            // Initialize progress for each character
            allLessonChars.forEach(char => {
                charProgress[char] = {
                    pinyin: false,
                    meaning: false
                };
            });
            
            loadTask();
            
            document.getElementById('nextBtn').addEventListener('click', function() {
                playSound(uiSounds.next); // Sound when going to next task
                loadTask();
            });
            
            // Add hover effects to buttons
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('mouseenter', () => {
                    playSound(uiSounds.hover); // Hover sound
                });
            });
        });
        
        // Load task
        function loadTask() {
            selectedLeft = null;
            selectedRight = null;
            matchedPairs = 0;
            
            // Determine available task types
            const remainingPinyin = allLessonChars.filter(char => !charProgress[char].pinyin);
            const remainingMeaning = allLessonChars.filter(char => !charProgress[char].meaning);
            
            if (remainingPinyin.length === 0 && remainingMeaning.length === 0) {
                // All characters fully learned
                playSound(uiSounds.complete); // Lesson completion sound
                document.getElementById('status').textContent = 'All characters in this lesson have been mastered!';
                document.getElementById('leftColumn').innerHTML = '';
                document.getElementById('rightColumn').innerHTML = '';
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('nextBtn').disabled = true;
                
                // Redirect to main page after 2 seconds
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                return;
            }
            
            // RANDOMLY SELECT task type
            const availableTypes = [];
            if (remainingPinyin.length > 0) availableTypes.push('pinyin');
            if (remainingMeaning.length > 0) availableTypes.push('meaning');
            
            // Randomly pick from available types
            const randomTypeIndex = Math.floor(Math.random() * availableTypes.length);
            currentTaskType = availableTypes[randomTypeIndex];
            
            const remainingChars = currentTaskType === 'pinyin' ? remainingPinyin : remainingMeaning;
            
            // Take up to 5 random from remaining
            const count = Math.min(5, remainingChars.length);
            currentChars = getRandomCharacters(remainingChars, count);
            
            createColumns(currentChars);
            updateProgress();
            updateStatus();
        }
        
        // Get random characters
        function getRandomCharacters(charArray, count) {
            const selectedChars = [];
            const tempArray = [...charArray];
            
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * tempArray.length);
                const char = tempArray[randomIndex];
                selectedChars.push({
                    char: char,
                    pinyin: charData[char].pinyin,
                    meaning: charData[char].meaning
                });
                tempArray.splice(randomIndex, 1);
            }
            
            return selectedChars;
        }
        
        // Create columns
        function createColumns(chars) {
            const leftColumn = document.getElementById('leftColumn');
            const rightColumn = document.getElementById('rightColumn');
            
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';
            
            // Update status header based on task type
            const statusText = currentTaskType === 'pinyin' ? 
                'Match characters with pronunciation' : 
                'Match characters with meanings';
            document.getElementById('status').textContent = statusText;
            
            // Left column - characters
            leftItems = [];
            chars.forEach(charData => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<div class="character">${charData.char}</div>`;
                item.dataset.char = charData.char;
                item.dataset.matched = 'false';
                item.addEventListener('click', () => {
                    playSound(uiSounds.click); // Click sound
                    selectItem(item, 'left');
                    // Play sound only on tasks involving translation
                    if (currentTaskType === 'meaning') {
                        playHanziSound(charData.char);
                    }
                });
                // Add hover effect
                item.addEventListener('mouseenter', () => {
                    playSound(uiSounds.hover); // Hover sound
                });
                leftColumn.appendChild(item);
                leftItems.push(item);
            });
            
            // Right column - one type (pinyin or meaning)
            rightItems = [];
            const shuffledChars = [...chars].sort(() => Math.random() - 0.5);
            
            shuffledChars.forEach(charData => {
                const item = document.createElement('div');
                item.className = 'item';
                
                if (currentTaskType === 'pinyin') {
                    item.innerHTML = `<div class="pinyin">${charData.pinyin}</div>`;
                    item.dataset.pinyin = charData.pinyin;
                    item.dataset.type = 'pinyin';
                } else {
                    item.innerHTML = `<div class="meaning">${charData.meaning}</div>`;
                    item.dataset.meaning = charData.meaning;
                    item.dataset.type = 'meaning';
                }
                
                item.dataset.char = charData.char;
                item.dataset.matched = 'false';
                item.addEventListener('click', () => {
                    playSound(uiSounds.click); // Click sound
                    selectItem(item, 'right');
                });
                // Add hover effect
                item.addEventListener('mouseenter', () => {
                    playSound(uiSounds.hover); // Hover sound
                });
                rightColumn.appendChild(item);
                rightItems.push(item);
            });
        }
        
        // Select item
        function selectItem(item, column) {
            if (item.dataset.matched === 'true') return;
            
            if (column === 'left') {
                if (selectedLeft) {
                    selectedLeft.classList.remove('selected');
                }
                selectedLeft = item;
                item.classList.add('selected');
                
                if (selectedRight) {
                    checkMatch();
                }
            } else {
                if (selectedRight) {
                    selectedRight.classList.remove('selected');
                }
                selectedRight = item;
                item.classList.add('selected');
                
                if (selectedLeft) {
                    checkMatch();
                }
            }
        }
        
        // Check match
        function checkMatch() {
            const leftChar = selectedLeft.dataset.char;
            let isMatch = false;
            
            if (currentTaskType === 'pinyin') {
                isMatch = (charData[leftChar].pinyin === selectedRight.dataset.pinyin);
            } else {
                isMatch = (charData[leftChar].meaning === selectedRight.dataset.meaning);
            }
            
            if (isMatch) {
                playSound(uiSounds.success); // Success sound
                showFeedback(true);
                updateUserPoints(1); // +1 point for correct answer
                
                // Play sound only for pinyin tasks on correct answer
                if (currentTaskType === 'pinyin') {
                    playHanziSound(leftChar);
                }
                
                selectedLeft.dataset.matched = 'true';
                selectedRight.dataset.matched = 'true';
                selectedLeft.classList.remove('selected');
                selectedLeft.classList.add('matched');
                selectedRight.classList.remove('selected');
                selectedRight.classList.add('matched');
                
                matchedPairs++;
                
                // If all pairs matched in current task
                if (matchedPairs === leftItems.length) {
                    // Mark characters as completed for current task type
                    leftItems.forEach(item => {
                        charProgress[item.dataset.char][currentTaskType] = true;
                    });
                    
                    // Update progress
                    updateProgress();
                    
                    // Enable next task button
                    document.getElementById('nextBtn').disabled = false;
                }
            } else {
                playSound(uiSounds.error); // Error sound
                showFeedback(false);
                updateUserPoints(-1); // -1 point for mistake
                
                selectedLeft.classList.remove('selected');
                selectedRight.classList.remove('selected');
            }
            
            selectedLeft = null;
            selectedRight = null;
        }
        
        // Show feedback
        function showFeedback(isCorrect) {
            const feedbackElement = isCorrect ? 
                document.getElementById('correctFeedback') : 
                document.getElementById('incorrectFeedback');
            
            feedbackElement.style.opacity = '1';
            
            setTimeout(() => {
                feedbackElement.style.opacity = '0';
            }, 1500);
        }
        
        // Update lesson progress
        function updateProgress() {
            // Count total completed checks (pinyin + meaning)
            let completedChecks = 0;
            allLessonChars.forEach(char => {
                if (charProgress[char].pinyin) completedChecks++;
                if (charProgress[char].meaning) completedChecks++;
            });
            
            const progress = (completedChecks / totalPairs) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }
        
        // Update status
        function updateStatus() {
            // Disable button until task is complete
            document.getElementById('nextBtn').disabled = true;
        }
    </script>
</body>
</html>